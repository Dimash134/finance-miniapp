<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å—ã ‚Äî MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color:#ffffff;
      --tg-theme-text-color:#000000;
      --tg-theme-hint-color:#777;
      --tg-theme-link-color:#2481cc;
      --tg-theme-button-color:#2481cc;
      --tg-theme-button-text-color:#ffffff;
      --tg-theme-secondary-bg-color:#f6f7fb;

      --primary:#3b82f6;
      --primary-dark:#2563eb;
      --success:#10b981;
      --danger:#ef4444;
      --bg-gradient:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      --radius:16px;
      --shadow:0 4px 10px rgba(0,0,0,.06);
      --shadow2:0 10px 24px rgba(0,0,0,.10);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .top-bar{
      position:sticky; top:0; z-index:50;
      background: var(--bg-gradient);
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.12);
    }
    .branch-select{
      background:#fff; color:#1f2937; border:0; border-radius:12px; padding:10px 14px; font-weight:700; min-width:160px;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    .menu-button{
      background:#fff; color:#667eea; border:0; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }

    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); opacity:0; pointer-events:none; transition:.2s; z-index:40}
    .overlay.show{opacity:1; pointer-events:auto}
    .side-menu{position:fixed; top:0; right:-300px; width:300px; height:100%; z-index:45; background:var(--tg-theme-bg-color);
      padding:22px 18px; box-shadow:-6px 0 24px rgba(0,0,0,.18); transition:right .25s}
    .side-menu.open{right:0}
    .side-menu h3{margin:0 0 12px; background:var(--bg-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .side-menu button{display:block; width:100%; margin:8px 0; padding:14px; border:0; border-radius:12px; background:var(--tg-theme-secondary-bg-color); cursor:pointer; font-weight:700}

    .container{max-width:980px; margin:0 auto; padding:18px}

    .dash-title{font-size:22px; font-weight:900; margin:6px 0 14px; background:var(--bg-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent}

    .dash-block{background:var(--tg-theme-secondary-bg-color); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:14px}
    .dash-block table{width:100%; border-collapse:collapse}
    .dash-block td{padding:12px 10px; border-bottom:1px solid rgba(0,0,0,.06)}
    .dash-block tr:last-child td{border-bottom:0}
    .dash-block td:first-child{color:var(--tg-theme-hint-color)}
    .dash-block td:last-child{text-align:right; font-weight:800}

    .tabs{display:flex; gap:8px; justify-content:center; margin:16px 0; background:var(--tg-theme-secondary-bg-color); padding:8px; border-radius:12px}
    .tab{border:0; padding:8px 14px; border-radius:10px; background:transparent; cursor:pointer; font-weight:800; color:#6b7280}
    .tab.active{background:var(--bg-gradient); color:#fff; box-shadow:var(--shadow)}

    .controls{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:8px}
    .controls input, .controls select, .controls button{padding:10px 12px; border-radius:10px; border:2px solid rgba(0,0,0,.08); background:#fff; font-weight:700}
    .controls button{background:var(--primary); color:#fff; border:0}

    .period-label{text-align:center; font-weight:800; margin:10px 0}

    .kpis{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:12px 0}
    .kpi{background:var(--tg-theme-secondary-bg-color); border-radius:var(--radius); padding:16px; text-align:center; box-shadow:var(--shadow)}
    .kpi .label{font-size:12px; color:#6b7280; margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi.income .value{color:#16a34a}
    .kpi.expense .value{color:#dc2626}
    .kpi.net .value{background:var(--bg-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent}

    table{width:100%; border-collapse:separate; border-spacing:0; background:#fff; border-radius:12px; overflow:hidden; box-shadow:var(--shadow)}
    td{padding:12px 14px; border-bottom:1px solid rgba(0,0,0,.06)}
    tr:last-child td{border-bottom:none}
    tr.positive td:nth-child(2){color:#16a34a; font-weight:900}
    tr.negative td:nth-child(2){color:#dc2626; font-weight:900}
    tr.total td{font-weight:900; background:#f8fafc}

    .btn-back{background:#fff; border:0; border-radius:10px; padding:8px 12px; font-weight:800; box-shadow:var(--shadow); cursor:pointer}

    @media (max-width:560px){
      .container{padding:12px}
      td:first-child{max-width:66vw; word-break:break-word}
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <select id="branch-select" class="branch-select">
      <option value="Private" selected>Private</option>
      <option value="Highschool">Highschool</option>
      <option value="Academy">Academy</option>
    </select>
    <button class="menu-button" id="menuBtn">–ú–µ–Ω—é</button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="side-menu" id="side-menu">
    <h3>–†–∞–∑–¥–µ–ª—ã</h3>
    <button data-section="dashboard">–ì–ª–∞–≤–Ω–∞—è</button>
    <button data-section="dds">–î–î–°</button>
    <button data-section="students">–£—á–µ–Ω–∏–∫–∏</button>
    <button data-section="staff">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
    <button data-section="calendar">–ü–ª–∞—Ç–µ–∂–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    <button data-section="report">–û—Ç—á–µ—Ç</button>
  </div>

  <div class="container">
    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <div id="dashboard-section">
      <div class="dash-title">–°–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>

      <!-- –ö–ù–û–ü–ö–ê –° –°–£–ú–ú–û–ô –°–≤–æ–¥!B6 -->
      <button id="svod-btn" class="menu-button" style="padding:12px 16px; margin-bottom:12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</button>

      <div class="dash-block"><table id="svod-p1"></table></div>
      <div class="dash-block"><table id="svod-p2"></table></div>
      <div class="dash-block"><table id="svod-p3"></table></div>
    </div>

    <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –°–≤–æ–¥ -->
    <div id="svod-details-section" style="display:none;">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <button class="btn-back" onclick="showOnly('dashboard-section')">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:900;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –°–≤–æ–¥</div>
      </div>
      <div class="dash-block"><table id="svod-detail-1"></table></div>
      <div class="dash-block"><table id="svod-detail-2"></table></div>
      <div class="dash-block"><table id="svod-detail-3"></table></div>
    </div>

    <!-- –î–î–° -->
    <div id="dds-section" style="display:none;">
      <div class="tabs">
        <div class="tab active" data-mode="—Ç–µ–∫—É—â–∏–π">–¢–µ–∫—É—â–∏–π</div>
        <div class="tab" data-mode="–º–µ—Å—è—Ü">–ú–µ—Å—è—Ü</div>
        <div class="tab" data-mode="–¥–∞—Ç–∞">–î–∞—Ç–∞</div>
      </div>
      <div class="controls" id="controls-date" style="display:none;">
        <input type="date" id="date-input" />
        <button onclick="setDate()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É</button>
      </div>
      <div class="controls" id="controls-month" style="display:none;">
        <select id="month-select"></select>
        <button onclick="setMonth()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—è—Ü</button>
      </div>
      <div class="period-label" id="period-label">–û—Ç—á—ë—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>

      <div class="kpis">
        <div class="kpi income"><div class="label">–î–æ—Ö–æ–¥</div><div class="value" id="kpi-income">0 ‚Ç∏</div></div>
        <div class="kpi expense"><div class="label">–†–∞—Å—Ö–æ–¥</div><div class="value" id="kpi-expense">0 ‚Ç∏</div></div>
        <div class="kpi net"><div class="label">–ß–∏—Å—Ç—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div><div class="value" id="kpi-net">0 ‚Ç∏</div></div>
      </div>

      <table id="summary-table"></table>

      <div style="display:flex; justify-content:flex-end; margin-top:12px;">
        <button id="btn-breakdown" class="menu-button" style="background:var(--primary); color:#fff;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</button>
      </div>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –∫–∞–∫ —Ä–∞–Ω—å—à–µ -->
    <div id="students-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeStudents()" class="btn-back">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:700;">–£—á–µ–Ω–∏–∫–∏ ‚Äî <span id="students-branch-label">Private</span></div>
      </div>
      <div class="tabs">
        <button id="students-tab-current" class="tab active">–¢–µ–∫—É—â–∏–π</button>
        <button id="students-tab-month" class="tab">–ú–µ—Å—è—Ü</button>
      </div>
      <div id="students-month-controls" class="controls" style="display:none;">
        <select id="students-month-select"></select>
        <button onclick="studentsSetMonth()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—è—Ü</button>
      </div>
      <div id="students-period-label" class="period-label">–û—Ç—á–µ—Ç (—Ç–µ–∫—É—â–∏–π)</div>
      <table id="students-table"></table>
    </div>

    <div id="staff-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeStaff()" class="btn-back">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:700;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ ‚Äî <span id="staff-branch-label">Private</span></div>
      </div>
      <div class="tabs">
        <button id="staff-tab-current" class="tab active">–¢–µ–∫—É—â–∏–π</button>
        <button id="staff-tab-month" class="tab">–ú–µ—Å—è—Ü</button>
      </div>
      <div id="staff-month-controls" class="controls" style="display:none;">
        <select id="staff-month-select"></select>
        <button onclick="staffSetMonth()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Å—è—Ü</button>
      </div>
      <div id="staff-period-label" class="period-label">–û—Ç—á–µ—Ç (—Ç–µ–∫—É—â–∏–π)</div>
      <table id="staff-table"></table>
    </div>

    <div id="pk-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closePK()" class="btn-back">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:700;">–ü–ª–∞—Ç–µ–∂–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å ‚Äî <span id="pk-branch-label">Private</span></div>
      </div>
      <table id="pk-header" style="margin-bottom:10px;"></table>
      <table id="pk-table"></table>
    </div>

    <div id="reports-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeReports()" class="btn-back">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:700;">–û—Ç—á—ë—Ç ‚Äî –æ–±—â–∏–π</div>
      </div>
      <div id="reports-list" style="display:flex; flex-direction:column; gap:12px;"></div>

      <div id="reports-upload" class="dash-block">
        <h4 style="margin:0 0 8px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å PDF</h4>
        <form id="upload-form" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="month" id="upload-ym" required>
          <input type="file" id="upload-file" accept="application/pdf" required>
          <button type="submit" class="menu-button" style="background:#16a34a; color:#fff;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button type="button" id="delete-btn" class="menu-button" style="background:#dc2626; color:#fff;">–£–¥–∞–ª–∏—Ç—å</button>
        </form>
        <div id="upload-msg" style="margin-top:6px; color:#16a34a; font-weight:700;"></div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ -->
  <div class="overlay" id="bd-modal" style="display:none; align-items:center; justify-content:center;">
    <div style="width:min(96vw,700px); max-height:80vh; overflow:auto; background:#fff; border-radius:16px; padding:16px; box-shadow:var(--shadow2);">
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <div id="bd-title" style="font-weight:900; margin-right:auto;">–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</div>
        <input id="bd-search" placeholder="–ü–æ–∏—Å–∫..." style="padding:10px 12px; border:2px solid #eee; border-radius:10px;">
        <button id="bd-close" class="menu-button" style="background:#dc2626; color:#fff;">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="bd-list"></div>
      <div id="bd-pager" style="margin-top:8px; text-align:center; color:#6b7280;"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg){ tg.ready(); tg.expand(); }

    const MONTHS=[{label:'–°–µ–Ω—Ç—è–±—Ä—å',value:9},{label:'–û–∫—Ç—è–±—Ä—å',value:10},{label:'–ù–æ—è–±—Ä—å',value:11},{label:'–î–µ–∫–∞–±—Ä—å',value:12},{label:'–Ø–Ω–≤–∞—Ä—å',value:1},{label:'–§–µ–≤—Ä–∞–ª—å',value:2},{label:'–ú–∞—Ä—Ç',value:3},{label:'–ê–ø—Ä–µ–ª—å',value:4},{label:'–ú–∞–π',value:5},{label:'–ò—é–Ω—å',value:6}];
    function fillMonthSelect(sel){ sel.innerHTML=MONTHS.map(m=>`<option value="${m.value}">${m.label}</option>`).join(''); }

    let currentMode='—Ç–µ–∫—É—â–∏–π';
    let currentBranch='Private';
    let studentsMode='current';
    let staffMode='current';

    // –º–µ–Ω—é
    const menu = document.getElementById('side-menu');
    const overlay = document.getElementById('overlay');
    document.getElementById('menuBtn').addEventListener('click', (e)=>{e.stopPropagation();toggleMenu(true);});
    overlay.addEventListener('click', ()=>toggleMenu(false));
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') toggleMenu(false); });
    function toggleMenu(open){ const toOpen=open ?? !menu.classList.contains('open'); if(toOpen){ menu.classList.add('open'); overlay.classList.add('show'); } else { menu.classList.remove('open'); overlay.classList.remove('show'); } }

    menu.querySelectorAll('button[data-section]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sec = btn.dataset.section; toggleMenu(false);
        if (sec==='dashboard'){ showOnly('dashboard-section'); initDashboard(); }
        else if (sec==='dds'){ showOnly('dds-section'); loadSummary(currentMode); updatePeriodLabel(currentMode); }
        else if (sec==='students'){ showOnly('students-section'); document.getElementById('students-branch-label').innerText=currentBranch; loadStudents(); }
        else if (sec==='staff'){ showOnly('staff-section'); document.getElementById('staff-branch-label').innerText=currentBranch; loadStaff(); }
        else if (sec==='calendar'){ showOnly('pk-section'); document.getElementById('pk-branch-label').innerText=currentBranch; loadPK(); }
        else if (sec==='report'){ showOnly('reports-section'); loadReports(); }
      });
    });

    function showOnly(id){
      ['dashboard-section','svod-details-section','dds-section','students-section','staff-section','pk-section','reports-section']
        .forEach(x=>document.getElementById(x).style.display=(x===id)?'block':'none');
    }
    function isVisible(id){ return document.getElementById(id).style.display==='block'; }

    // –≤—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞
    const branchSelect = document.getElementById('branch-select');
    currentBranch = branchSelect.value || 'Private';
    branchSelect.addEventListener('change', ()=>{
      currentBranch = branchSelect.value;
      if(isVisible('dashboard-section')) initDashboard();
      if(isVisible('dds-section')){ loadSummary(currentMode); updatePeriodLabel(currentMode); }
      if(isVisible('students-section')){ document.getElementById('students-branch-label').innerText=currentBranch; loadStudents(); }
      if(isVisible('staff-section')){ document.getElementById('staff-branch-label').innerText=currentBranch; loadStaff(); }
      if(isVisible('pk-section')){ document.getElementById('pk-branch-label').innerText=currentBranch; loadPK(); }
      if(isVisible('reports-section')) loadReports();
    });

    // —Ñ–æ—Ä–º–∞—Ç
    function parseNumber(s){
      if(typeof s!=='string') return Number(s)||0;
      const cleaned=s.replace(/[^\d,.\- ]/g,'').replace(/\s/g,'');
      if(cleaned.includes(',') && !cleaned.includes('.')) return parseFloat(cleaned.replace(',','.'))||0;
      return parseFloat(cleaned)||0;
    }
    const fmt=n=>Number.isFinite(n)?n.toLocaleString('ru-RU'):String(n);

    // –°–í–û–î (–≥–ª–∞–≤–Ω–∞—è)
    function renderBlock(elId, rows){
      const html=(rows||[]).map(r=>`<tr><td>${r[0]??''}</td><td>${r[1]??''}</td></tr>`).join('');
      document.getElementById(elId).innerHTML=html;
    }
    function loadSvod(){
      fetch('/svod').then(r=>r.json()).then(d=>{
        renderBlock('svod-p1', d.p1||[]);
        renderBlock('svod-p2', d.p2||[]);
        renderBlock('svod-p3', d.p3||[]);
      });
    }
    function loadSvodBtn(){
      fetch('/svod-details').then(r=>r.json()).then(d=>{
        const btn=document.getElementById('svod-btn');
        btn.textContent = d.b6 ? d.b6 : '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é';
        btn.onclick = ()=>{
          showOnly('svod-details-section');
          renderSvodDetails(d);
        };
      });
    }
    function renderSvodDetails(d){
      const mk = a => (a||[]).map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join('');
      document.getElementById('svod-detail-1').innerHTML = mk(d.part1);
      document.getElementById('svod-detail-2').innerHTML = mk(d.part2);
      document.getElementById('svod-detail-3').innerHTML = mk(d.part3);
    }
    function initDashboard(){ loadSvod(); loadSvodBtn(); }

    // –î–î–°
    function buildSummaryTable(rows, net){
      const tb=document.getElementById('summary-table');
      const body = rows.map(r=>{
        const name=r[0]??''; const raw=r[1]??''; const val=parseNumber(raw);
        const cls = val>0?'positive':(val<0?'negative':'');
        return `<tr class="${cls}"><td>${name}</td><td style="text-align:right">${fmt(val)}</td></tr>`;
      }).join('');
      tb.innerHTML = body + `<tr class="total"><td>–ò–¢–û–ì–û (—á–∏—Å—Ç—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)</td><td style="text-align:right">${fmt(net)}</td></tr>`;
    }
    function loadSummary(mode){
      fetch(`/summary?mode=${encodeURIComponent(mode)}&branch=${encodeURIComponent(currentBranch)}`)
        .then(r=>r.json())
        .then(rows=>{
          let income=0, expense=0;
          rows.forEach(r=>{ if(r.length<2) return; const v=parseNumber(r[1]); if(v>0) income+=v; else expense+=Math.abs(v); });
          const net=income-expense;
          document.getElementById('kpi-income').textContent  = `${fmt(income)} ‚Ç∏`;
          document.getElementById('kpi-expense').textContent = `${fmt(expense)} ‚Ç∏`;
          document.getElementById('kpi-net').textContent     = `${fmt(net)} ‚Ç∏`;
          buildSummaryTable(rows, net);
        });
    }
    function updatePeriodLabel(mode){
      const label=document.getElementById('period-label');
      const today=(()=>{const d=new Date(); const t=n=>n<10?`0${n}`:n; return `${t(d.getDate())}.${t(d.getMonth()+1)}.${d.getFullYear()}`;})();
      if(mode==='—Ç–µ–∫—É—â–∏–π') label.textContent = `–û—Ç—á—ë—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (${currentBranch}): ${today}`;
      else if(mode==='–¥–∞—Ç–∞'){
        const v=document.getElementById('date-input').value;
        if(v){ const [y,m,d]=v.split('-'); label.textContent=`–û—Ç—á—ë—Ç –Ω–∞ ${d}.${m}.${y} (${currentBranch})`; }
        else label.textContent=`–û—Ç—á—ë—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É (${currentBranch})`;
      }else{
        const mSel=document.getElementById('month-select'); const lab=mSel.options[mSel.selectedIndex]?.text||'–º–µ—Å—è—Ü';
        label.textContent = `–û—Ç—á—ë—Ç –∑–∞ –º–µ—Å—è—Ü: ${lab} (${currentBranch})`;
      }
    }
    function activateDdsTab(mode){
      document.querySelectorAll('#dds-section .tab').forEach(t=>t.classList.toggle('active', t.dataset.mode===mode));
      document.getElementById('controls-date').style.display  = (mode==='–¥–∞—Ç–∞')   ? 'flex' : 'none';
      document.getElementById('controls-month').style.display = (mode==='–º–µ—Å—è—Ü')  ? 'flex' : 'none';
    }
    function setDate(){
      const v=document.getElementById('date-input').value;
      if(!v) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
      const [y,m,d]=v.split('-'); const formatted=`${d}.${m}.${y}`;
      fetch(`/set-date?value=${encodeURIComponent(formatted)}&branch=${encodeURIComponent(currentBranch)}`)
        .then(()=>{ currentMode='–¥–∞—Ç–∞'; activateDdsTab('–¥–∞—Ç–∞'); loadSummary('–¥–∞—Ç–∞'); updatePeriodLabel('–¥–∞—Ç–∞'); document.activeElement?.blur(); });
    }
    function setMonth(){
      const m=document.getElementById('month-select').value;
      fetch(`/set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`)
        .then(()=>{ currentMode='–º–µ—Å—è—Ü'; activateDdsTab('–º–µ—Å—è—Ü'); loadSummary('–º–µ—Å—è—Ü'); updatePeriodLabel('–º–µ—Å—è—Ü'); document.activeElement?.blur(); });
    }
    document.querySelectorAll('#dds-section .tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        const mode=tab.dataset.mode; currentMode=mode;
        activateDdsTab(mode); loadSummary(mode); updatePeriodLabel(mode);
      });
    });

    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ (–º–æ–¥–∞–ª–∫–∞)
    const bdModal = document.getElementById('bd-modal');
    const bdList  = document.getElementById('bd-list');
    const bdPager = document.getElementById('bd-pager');
    let bdPage=1, bdLimit=50, bdTotal=0;

    document.getElementById('btn-breakdown').addEventListener('click', ()=>{
      bdPage=1; fetchBreakdown(); bdModal.style.display='flex';
    });
    document.getElementById('bd-close').addEventListener('click', ()=>{bdModal.style.display='none';});
    document.getElementById('bd-search').addEventListener('input', ()=>{ clearTimeout(window.__bd_t); window.__bd_t=setTimeout(()=>{bdPage=1; fetchBreakdown();},300); });

    function fetchBreakdown(){
      const search = document.getElementById('bd-search').value.trim();
      const q = new URLSearchParams({branch:currentBranch, scope:currentMode, page:bdPage, limit:bdLimit, search});
      fetch(`/breakdown?${q.toString()}`).then(r=>r.json()).then(d=>{
        bdTotal=d.total||0;
        renderBreakdown(d.data||[]);
        const from=Math.min((bdPage-1)*bdLimit+1, bdTotal), to=Math.min(bdPage*bdLimit, bdTotal);
        bdPager.innerHTML = `${bdTotal?from:0}-${to} –∏–∑ ${bdTotal}
          &nbsp;<button class="menu-button" style="padding:6px 10px" ${bdPage<=1?'disabled':''} onclick="bdPrev()">‚Üê</button>
          <button class="menu-button" style="padding:6px 10px" ${bdPage*bdLimit>=bdTotal?'disabled':''} onclick="bdNext()">‚Üí</button>`;
      });
    }
    window.bdPrev=()=>{ if(bdPage>1){ bdPage--; fetchBreakdown(); } };
    window.bdNext=()=>{ if(bdPage*bdLimit<bdTotal){ bdPage++; fetchBreakdown(); } };
    function renderBreakdown(rows){
      bdList.innerHTML = rows.map(x=>{
        const raw=(x.amount||'').toString(); const val=parseNumber(raw);
        const cls=Number.isFinite(val)?(val<0?'negative':'positive'):'';
        return `<div style="border-bottom:1px solid #eee; padding:10px 6px;">
          <div style="display:flex; justify-content:space-between; gap:8px; font-weight:700;">
            <div>${x.article||''}</div>
            <div class="${cls==='positive'?'':'negative'}">${raw}</div>
          </div>
          <div style="color:#6b7280; margin-top:6px; line-height:1.6">
            <div><b>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</b> ${x.counterparty||'-'}</div>
            <div><b>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</b> ${x.purpose||'-'}</div>
          </div>
        </div>`;
      }).join('');
    }

    // –£—á–µ–Ω–∏–∫–∏/–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏/–ü–ö/–û—Ç—á—ë—Ç—ã ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ
    function closeStudents(){ showOnly('dashboard-section'); }
    function studentsSetMonth(){ const m=document.getElementById('students-month-select').value; fetch(`/students-set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`).then(()=>loadStudents()); }
    function loadStudents(){ fetch(`/students?branch=${encodeURIComponent(currentBranch)}&mode=${encodeURIComponent(studentsMode)}`).then(r=>r.json()).then(d=>{ const rows=d?.rows||[]; document.getElementById('students-table').innerHTML=rows.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join(''); }); }
    document.getElementById('students-tab-current')?.addEventListener('click',()=>{ studentsMode='current'; document.getElementById('students-tab-current').classList.add('active'); document.getElementById('students-tab-month').classList.remove('active'); document.getElementById('students-month-controls').style.display='none'; document.getElementById('students-period-label').innerText='–û—Ç—á–µ—Ç (—Ç–µ–∫—É—â–∏–π)'; loadStudents(); });
    document.getElementById('students-tab-month')?.addEventListener('click',()=>{ studentsMode='month'; document.getElementById('students-tab-month').classList.add('active'); document.getElementById('students-tab-current').classList.remove('active'); document.getElementById('students-month-controls').style.display='flex'; document.getElementById('students-period-label').innerText='–û—Ç—á–µ—Ç (–º–µ—Å—è—Ü)'; loadStudents(); });

    function closeStaff(){ showOnly('dashboard-section'); }
    function staffSetMonth(){ const m=document.getElementById('staff-month-select').value; fetch(`/staff-set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`).then(()=>loadStaff()); }
    function loadStaff(){ fetch(`/staff?branch=${encodeURIComponent(currentBranch)}&mode=${encodeURIComponent(staffMode)}`).then(r=>r.json()).then(d=>{ const rows=d?.rows||[]; document.getElementById('staff-table').innerHTML=rows.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join(''); }); }
    document.getElementById('staff-tab-current')?.addEventListener('click',()=>{ staffMode='current'; document.getElementById('staff-tab-current').classList.add('active'); document.getElementById('staff-tab-month').classList.remove('active'); document.getElementById('staff-month-controls').style.display='none'; document.getElementById('staff-period-label').innerText='–û—Ç—á–µ—Ç (—Ç–µ–∫—É—â–∏–π)'; loadStaff(); });
    document.getElementById('staff-tab-month')?.addEventListener('click',()=>{ staffMode='month'; document.getElementById('staff-tab-month').classList.add('active'); document.getElementById('staff-tab-current').classList.remove('active'); document.getElementById('staff-month-controls').style.display='flex'; document.getElementById('staff-period-label').innerText='–û—Ç—á–µ—Ç (–º–µ—Å—è—Ü)'; loadStaff(); });

    function closePK(){ showOnly('dashboard-section'); }
    function loadPK(){
      fetch(`/pk?branch=${encodeURIComponent(currentBranch)}`).then(r=>r.json()).then(d=>{
        const header = d?.header||[], table = d?.table||[];
        document.getElementById('pk-header').innerHTML = header.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join('');
        document.getElementById('pk-table').innerHTML  = table.map(r=>`<tr><td>${r[0]??''}</td><td>${r[1]??''}</td><td style="text-align:right">${r[2]??''}</td></tr>`).join('');
      });
    }

    function closeReports(){ showOnly('dashboard-section'); }
    function loadReports(){
      fetch(`/reports`).then(r=>r.json()).then(d=>{
        const list = d?.months||[];
        const html = list.map(m=>{
          return `<div class="dash-block"><div style="font-weight:900; margin-bottom:6px;">${m.title}</div>${
            (m.files||[]).map(f=>`<div style="display:flex; align-items:center; gap:8px; margin:6px 0;"><a href="${f.url}" target="_blank">üìÑ ${f.name}</a></div>`).join('')
          }</div>`;
        }).join('');
        document.getElementById('reports-list').innerHTML = html || '<div class="dash-block">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</div>';
      });
    }

    // –∑–∞–≥—Ä—É–∑–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤
    document.getElementById('upload-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ym=document.getElementById('upload-ym').value;
      const file=document.getElementById('upload-file').files[0];
      const msg=document.getElementById('upload-msg');
      if(!ym||!file){ msg.textContent='–í—ã–±–µ—Ä–∏ –º–µ—Å—è—Ü –∏ —Ñ–∞–π–ª.'; return; }
      const fd=new FormData(); fd.append('ym',ym); fd.append('file',file);
      const res = await fetch('/reports/upload',{method:'POST', body:fd});
      if(res.ok){ msg.textContent='–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω ‚úÖ'; document.getElementById('upload-file').value=''; loadReports(); }
      else{ const t=await res.json().catch(()=>({error:'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'})); msg.textContent=`–û—à–∏–±–∫–∞: ${t.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`; msg.style.color='#dc2626'; }
      setTimeout(()=>msg.textContent='', 3000);
    });
    document.getElementById('delete-btn').addEventListener('click', async ()=>{
      const ym=prompt('–ü–µ—Ä–∏–æ–¥ (YYYY-MM):'); const name=prompt('–ò–º—è —Ñ–∞–π–ª–∞:'); if(!ym||!name) return;
      await fetch('/reports/delete',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ym,name})});
      loadReports();
    });

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', ()=>{
      fillMonthSelect(document.getElementById('month-select'));
      fillMonthSelect(document.getElementById('students-month-select'));
      fillMonthSelect(document.getElementById('staff-month-select'));

      // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
      initDashboard();

      // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª—ë–≥–∫–∏–µ
      setInterval(()=>{
        if(isVisible('dds-section')) loadSummary(currentMode);
      }, 30000);
    });
  </script>
</body>
</html>
