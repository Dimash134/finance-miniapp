<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Финансы — MiniApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  /* Палитра и тени */
  --bg:#0b1020;          /* тёмный фон — чище контраст на телефонах */
  --bg-2:#0f152a;
  --card:#121a34;
  --line:#1f2b4a;
  --muted:#9fb0d0;

  --green:#22c55e;       /* успех */
  --green-2:#16a34a;
  --red:#ef4444;         /* ошибка */
  --red-2:#dc2626;

  --ink:#e6eeff;         /* базовый текст */
  --ink-soft:#c9d6f3;

  --ring:#3b82f6;        /* фокус */
  --shadow: 0 8px 24px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.03) inset;
  --shadow-soft: 0 6px 18px rgba(0,0,0,.25);
}

/* База */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 600px at 10% -10%, #1c2750 0%, #0b1020 55%) fixed;
  color:var(--ink); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
}

/* Верхняя панель */
.top-bar{
  position:sticky; top:0; z-index:100;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  background:linear-gradient(90deg,#1c2750,#0f1b3d);
  border-bottom:1px solid #1f2b4a; color:var(--ink);
  padding:10px 16px; box-shadow:var(--shadow-soft);
}
.branch-select{
  background:var(--card); color:var(--ink);
  border:1px solid var(--line); border-radius:10px;
  padding:8px 10px; min-width:160px; font-size:14px; outline:none;
}
.branch-select:focus{box-shadow:0 0 0 2px var(--ring); border-color:transparent}
.menu-button{
  background:linear-gradient(180deg,#3b82f6,#2563eb);
  color:#fff; border:0; border-radius:12px; padding:8px 14px;
  font-weight:700; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s ease;
}
.menu-button:active{transform:translateY(1px)}

/* Боковое меню */
.side-menu{
  position:fixed; top:0; right:-280px; width:280px; height:100%;
  background:linear-gradient(180deg,#0f152a,#0b1020); border-left:1px solid var(--line);
  box-shadow:-16px 0 40px rgba(0,0,0,.45); padding:18px; transition:right .25s ease; z-index:1000;
}
.side-menu.open{right:0}
.side-menu h3{margin:0 0 8px; color:var(--ink); font-size:16px}
.side-menu button{
  display:block; width:100%; margin:10px 0; padding:12px; font-size:15px;
  background:var(--card); color:var(--ink); border:1px solid var(--line); border-radius:12px; cursor:pointer;
}
.side-menu button:hover{border-color:#2b3b68}
.overlay{position:fixed; inset:0; background:rgba(7,10,18,.5); opacity:0; pointer-events:none; transition:opacity .2s; z-index:900}
.overlay.show{opacity:1; pointer-events:auto}

/* Контейнер */
.container{padding:16px; max-width:900px; margin:0 auto}

/* Карточки (главная + отчёты) */
.dash-block{
  background:linear-gradient(180deg,#121a34,#0f172e);
  border:1px solid var(--line); border-radius:16px; padding:14px; margin-bottom:12px;
  box-shadow:var(--shadow);
}
.dash-block table{width:100%; border-collapse:collapse}
.dash-block td{padding:10px 8px; border-bottom:1px dashed #233257; font-size:15px; color:var(--ink)}
.dash-block tr:last-child td{border-bottom:none}

/* Вкладки и контролы */
.tabs{display:flex; gap:8px; justify-content:center; margin:16px 0 10px; flex-wrap:wrap}
.tab{
  padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:700;
  background:rgba(255,255,255,.06); color:var(--ink); border:1px solid transparent;
}
.tab.active{background:rgba(59,130,246,.2); border-color:#3b82f6}
.controls{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:10px}
.controls input, .controls button, .controls select{
  padding:10px 12px; border-radius:10px; border:1px solid var(--line); font-size:14px;
  background:var(--card); color:var(--ink); min-height:42px; outline:none;
}
.controls input:focus, .controls select:focus{box-shadow:0 0 0 2px var(--ring); border-color:transparent}
.controls button{cursor:pointer; background:linear-gradient(180deg,#3b82f6,#2563eb); border:0; color:#fff}

/* KPI — компактные карточки */
.kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; max-width:720px; margin:0 auto 12px}
.kpi{
  background:linear-gradient(180deg,#121a34,#0f172e);
  border:1px solid var(--line); border-radius:16px; padding:14px; text-align:center; box-shadow:var(--shadow);
}
.kpi .label{font-size:12px; color:var(--ink-soft); margin-bottom:6px; letter-spacing:.2px}
.kpi .value{font-size:20px; font-weight:800}
.kpi.income .value{color:var(--green)}
.kpi.expense .value{color:var(--red)}
.kpi.net .value{color:#60a5fa}

/* Таблицы данных */
table{width:100%; border-collapse:separate; border-spacing:0; background:var(--card);
       border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:var(--shadow)}
td{padding:12px 14px; border-bottom:1px solid #1c294b; font-size:15px; color:var(--ink)}
tr:last-child td{border-bottom:none}
tr:hover td{background:#0f172e}
tr.positive td:nth-child(2){color:var(--green)}
tr.negative td:nth-child(2){color:var(--red)}
tr.total td{font-weight:900; background:#0f172e; border-top:2px solid #24335a}

/* Платёжный календарь */
#pk-header{border:0; background:transparent; border-collapse:separate; border-spacing:0 10px}
#pk-header td{background:var(--card); border:1px solid var(--line); padding:12px 14px; font-size:15px; font-weight:700; border-radius:12px; box-shadow:var(--shadow-soft)}
#pk-table{border:0; background:transparent; border-collapse:separate; border-spacing:0 10px;}
#pk-table td{background:var(--card); border:1px solid var(--line); padding:12px 14px; font-size:15px; border-radius:12px; box-shadow:var(--shadow-soft)}
.pk-pos{color:var(--green); font-weight:700}
.pk-neg{color:var(--red); font-weight:700}
.pk-bad{background:rgba(239,68,68,.12) !important; color:#fecaca; font-weight:800; border-color:#7f1d1d !important}
.pk-inout{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center;}
.pk-inout .pk-income{ color:var(--green); font-weight:800; line-height:1; }
.pk-inout .pk-expense{ color:var(--red);   font-weight:800; line-height:1; }

/* Отчёты */
.report-file{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid var(--line); border-radius:10px;
  background:#0f172e; color:var(--ink); margin:6px 0;
}
.report-file a{flex:1; text-decoration:none; color:#93c5fd}
.rep-chk{ display:none; }
.rep-chk.show{ display:inline-block; }

/* Модалка «Расшифровка» */
.modal{position:fixed; inset:0; background:rgba(4,6,12,.65); display:none; align-items:center; justify-content:center; z-index:1200}
.modal.show{display:flex}
.modal-body{
  width:min(96vw,720px);
  max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  overflow:auto; background:linear-gradient(180deg,#111935,#0c132a);
  border:1px solid #233257; border-radius:16px; padding:12px; box-shadow:var(--shadow);
}
.bd-head{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap}
.bd-head input{padding:10px 12px; border:1px solid var(--line); border-radius:10px; flex:1 1 240px; min-width:0; background:#0f172e; color:var(--ink)}
.bd-head input:focus{box-shadow:0 0 0 2px var(--ring); border-color:transparent}
.row{border-bottom:1px solid #1c294b; padding:12px 6px; cursor:pointer}
.top{display:flex; justify-content:space-between; gap:8px; font-weight:600}
.bottom{margin-top:6px; font-size:14px; color:var(--ink-soft); display:none}
.row.open .bottom{display:block}
.amount{white-space:nowrap}
.amt-pos{color:var(--green); font-weight:800}
.amt-neg{color:var(--red);   font-weight:800}

/* Адаптив */
@media (max-width:560px){
  .container{padding:12px}
  .kpis{grid-template-columns:1fr; gap:10px}
  .kpi .value{font-size:18px}
  td:first-child{max-width:70vw; word-break:break-word}
}
</style>
</head>
<body>
  <div class="top-bar">
    <select id="branch-select" class="branch-select">
      <option value="Private" selected>Private</option>
      <option value="Highschool">Highschool</option>
      <option value="Academy">Academy</option>
    </select>
    <button class="menu-button" id="menuBtn">Меню</button>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="side-menu" id="side-menu">
    <h3>Разделы</h3>
    <!-- Без "Главная" -->
    <button data-section="dds">ДДС</button>
    <button data-section="students">Ученики</button>
    <button data-section="staff">Сотрудники</button>
    <button data-section="calendar">Платежный календарь</button>
    <button data-section="report">Отчет</button>
  </div>

  <div class="container">
    <!-- Главная (Свод) -->
    <div id="dashboard-section">
      <div class="dash-block"><table id="svod-p1"></table></div>
      <div class="dash-block"><table id="svod-p2"></table></div>
      <div class="dash-block"><table id="svod-p3"></table></div>
    </div>

    <!-- ДДС -->
    <div id="dds-section" style="display:none;">
      <div class="tabs" style="margin-top:8px;">
        <div class="tab active" data-mode="текущий">Текущий</div>
        <div class="tab" data-mode="месяц">Месяц</div>
        <div class="tab" data-mode="дата">Дата</div>
      </div>
      <div class="controls" id="controls-date" style="display:none;">
        <input type="date" id="date-input" />
        <button onclick="setDate()">Установить дату</button>
      </div>
      <div class="controls" id="controls-month" style="display:none;">
        <select id="month-select"></select>
        <button onclick="setMonth()">Установить месяц</button>
      </div>
      <div class="period-label" id="period-label">Отчёт на сегодня</div>

      <div class="kpis">
        <div class="kpi income"><div class="label">Доход</div><div class="value" id="kpi-income">0 ₸</div></div>
        <div class="kpi expense"><div class="label">Расход</div><div class="value" id="kpi-expense">0 ₸</div></div>
        <div class="kpi net"><div class="label">Чистый результат</div><div class="value" id="kpi-net">0 ₸</div></div>
      </div>

      <table id="summary-table"></table>
      <div style="display:flex; justify-content:flex-end; margin-top:10px;">
        <button id="btn-breakdown" class="menu-button" style="background:#fff; border:1px solid #ccc; color:#111;">Расшифровка</button>
      </div>
    </div>

    <!-- Ученики -->
    <div id="students-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeStudents()">← Назад</button>
        <div style="font-weight:700;">Ученики — <span id="students-branch-label">Private</span></div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
        <button id="students-tab-current" class="tab active" style="padding:6px 12px; border-radius:16px;">Текущий</button>
        <button id="students-tab-month" class="tab" style="padding:6px 12px; border-radius:16px;">Месяц</button>
        <div id="students-month-controls" style="display:none; margin-left:6px;">
          <select id="students-month-select"></select>
          <button onclick="studentsSetMonth()" style="padding:6px 8px; border:1px solid #ccc; border-radius:6px; background:#fff;">Установить месяц</button>
        </div>
      </div>
      <div id="students-period-label" style="font-weight:600; margin-bottom:8px;">Отчет (текущий)</div>
      <table id="students-table"></table>
    </div>

    <!-- Сотрудники -->
    <div id="staff-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeStaff()">← Назад</button>
        <div style="font-weight:700;">Сотрудники — <span id="staff-branch-label">Private</span></div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
        <button id="staff-tab-current" class="tab active" style="padding:6px 12px; border-radius:16px;">Текущий</button>
        <button id="staff-tab-month" class="tab" style="padding:6px 12px; border-radius:16px;">Месяц</button>
        <div id="staff-month-controls" style="display:none; margin-left:6px;">
          <select id="staff-month-select"></select>
          <button onclick="staffSetMonth()" style="padding:6px 8px; border:1px solid #ccc; border-radius:6px; background:#fff;">Установить месяц</button>
        </div>
      </div>
      <div id="staff-period-label" style="font-weight:600; margin-bottom:8px;">Отчет (текущий)</div>
      <table id="staff-table"></table>
    </div>

    <!-- Платёжный календарь -->
    <div id="pk-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closePK()">← Назад</button>
        <div style="font-weight:700;">Платежный календарь — <span id="pk-branch-label">Private</span></div>
      </div>
      <table id="pk-header" style="margin-bottom:10px;"></table>
      <table id="pk-table"></table>
    </div>

    <!-- Отчёт (PDF архив) -->
    <div id="reports-section" style="display:none; padding-top:10px;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <button onclick="closeReports()">← Назад</button>
        <div style="font-weight:700;">Отчёт — общий</div>
      </div>
      <div id="reports-list" style="display:flex; flex-direction:column; gap:12px;"></div>
      <div id="reports-upload" style="margin-top:16px;">
        <h4 style="margin:6px 0;">Загрузить PDF</h4>
        <form id="upload-form" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="month" id="upload-ym" required style="padding:8px; border:1px solid #ddd; border-radius:6px;">
          <input type="file" id="upload-file" accept="application/pdf" required style="padding:8px;">
          <button type="submit" class="menu-button" style="padding:8px 12px;">Загрузить</button>
          <button type="button" id="delete-btn" class="menu-button" style="padding:8px 12px; background:#fff; color:#b71c1c; border:1px solid #e2bcbc;">Удалить</button>
        </form>
        <div id="upload-msg" style="margin-top:6px; color:#2e7d32; font-weight:700;"></div>
      </div>
    </div>
  </div>

  <!-- Модалка «Расшифровка» -->
  <div class="modal" id="bd-modal">
    <div class="modal-body">
      <div class="bd-head">
        <div id="bd-title" style="font-weight:800; margin-right:auto;">Расшифровка</div>
        <input id="bd-search" placeholder="Поиск по контрагенту/назначению/статье">
        <button id="bd-close" class="menu-button" style="background:#fff; border:1px solid #ccc; color:#111;">Закрыть</button>
      </div>
      <div id="bd-list"></div>
      <div id="bd-pager" style="margin-top:8px; color:#666; font-size:13px;"></div>
    </div>
  </div>

<script>
  const MONTHS=[{label:'Сентябрь',value:9},{label:'Октябрь',value:10},{label:'Ноябрь',value:11},{label:'Декабрь',value:12},{label:'Январь',value:1},{label:'Февраль',value:2},{label:'Март',value:3},{label:'Апрель',value:4},{label:'Май',value:5},{label:'Июнь',value:6}];
  function fillMonthSelect(sel){ sel.innerHTML=MONTHS.map(m=>`<option value="${m.value}">${m.label}</option>`).join(''); }
  let currentMode='текущий'; let currentBranch='Private'; let studentsMode='current'; let staffMode='current';

  // меню
  const menu=document.getElementById('side-menu'); const overlay=document.getElementById('overlay');
  document.getElementById('menuBtn').addEventListener('click',e=>{e.stopPropagation();toggleMenu(true);});
  overlay.addEventListener('click',()=>toggleMenu(false));
  document.addEventListener('keydown',e=>{if(e.key==='Escape')toggleMenu(false);});
  function toggleMenu(open){ const toOpen=open ?? !menu.classList.contains('open'); if(toOpen){menu.classList.add('open');overlay.classList.add('show');} else {menu.classList.remove('open');overlay.classList.remove('show');}}
  menu.querySelectorAll('button[data-section]').forEach(btn=>{
    btn.addEventListener('click',()=>{ const sec=btn.dataset.section; toggleMenu(false);
      showOnly(sec==='dds'?'dds-section':
               sec==='students'?'students-section':
               sec==='staff'?'staff-section':
               sec==='calendar'?'pk-section':'reports-section');
      if(sec==='dds'){ loadSummary(currentMode); updatePeriodLabel(currentMode); }
      if(sec==='students'){ document.getElementById('students-branch-label').innerText=currentBranch; loadStudents(); }
      if(sec==='staff'){ document.getElementById('staff-branch-label').innerText=currentBranch; loadStaff(); }
      if(sec==='calendar'){ document.getElementById('pk-branch-label').innerText=currentBranch; loadPK(); }
      if(sec==='report'){ loadReports(); }
    });
  });

  function showOnly(id){
    ['dashboard-section','dds-section','students-section','staff-section','pk-section','reports-section']
      .forEach(x=>document.getElementById(x).style.display = (x===id)?'block':'none');
  }
  function isVisible(id){ return document.getElementById(id).style.display==='block'; }

  const branchSelect=document.getElementById('branch-select');
  currentBranch=branchSelect.value||'Private';
  branchSelect.addEventListener('change',()=>{
    currentBranch=branchSelect.value;
    if(isVisible('dds-section')){ loadSummary(currentMode); updatePeriodLabel(currentMode); }
    if(isVisible('students-section')){ document.getElementById('students-branch-label').innerText=currentBranch; loadStudents(); }
    if(isVisible('staff-section')){ document.getElementById('staff-branch-label').innerText=currentBranch; loadStaff(); }
    if(isVisible('pk-section')){ document.getElementById('pk-branch-label').innerText=currentBranch; loadPK(); }
    if(isVisible('reports-section'))  loadReports();
  });

  // ===== Главная (Свод)
  function renderBlock(elId, rows){
    const html=(rows||[]).map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join('');
    document.getElementById(elId).innerHTML=html;
  }
  function loadSvod(){
    fetch('/svod').then(r=>r.json()).then(d=>{
      renderBlock('svod-p1', d.p1||[]);
      renderBlock('svod-p2', d.p2||[]);
      renderBlock('svod-p3', d.p3||[]);
    });
  }

  // ===== ДДС
  function parseNumber(s){ if(typeof s!=='string') return Number(s)||0; const cleaned=s.replace(/[^\d,.\- ]/g,'').replace(/\s/g,''); return cleaned.includes(',')&&!cleaned.includes('.')?parseFloat(cleaned.replace(',','.'))||0:parseFloat(cleaned)||0; }
  const fmt=n=>Number.isFinite(n)?n.toLocaleString('ru-RU'):String(n);
  const fmt2=n=>Number.isFinite(n)?n.toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}):String(n);

  function buildSummaryTable(rows, net){
    const tb=document.getElementById('summary-table');
    const body = rows.map(r=>{
      const name=r[0]??''; const raw=r[1]??''; const val=parseNumber(raw);
      const cls = val>0?'positive':(val<0?'negative':'');
      return `<tr class="${cls}"><td>${name}</td><td style="text-align:right">${fmt(val)}</td></tr>`;
    }).join('');
    tb.innerHTML = body + `<tr class="total"><td>ИТОГО (чистый результат)</td><td style="text-align:right">${fmt(net)}</td></tr>`;
  }
  function loadSummary(mode){
    fetch(`/summary?mode=${encodeURIComponent(mode)}&branch=${encodeURIComponent(currentBranch)}`)
      .then(r=>r.json()).then(rows=>{
        let income=0, expense=0;
        rows.forEach(r=>{ if(r.length<2) return; const v=parseNumber(r[1]); if(v>0) income+=v; else expense+=Math.abs(v); });
        const net=income-expense;
        document.getElementById('kpi-income').textContent=`${fmt(income)} ₸`;
        document.getElementById('kpi-expense').textContent=`${fmt(expense)} ₸`;
        document.getElementById('kpi-net').textContent=`${fmt(net)} ₸`;
        buildSummaryTable(rows, net);
      });
  }
  function updatePeriodLabel(mode){
    const label=document.getElementById('period-label');
    const today=(()=>{const d=new Date(); const t=n=>n<10?`0${n}`:n; return `${t(d.getDate())}.${t(d.getMonth()+1)}.${d.getFullYear()}`;})();
    if(mode==='текущий') label.textContent=`Отчёт на сегодня (${currentBranch}): ${today}`;
    else if(mode==='дата'){
      const v=document.getElementById('date-input').value;
      label.textContent = v ? `Отчёт на ${v.split('-').reverse().join('.')} (${currentBranch})` : `Отчёт на выбранную дату (${currentBranch})`;
    }else{
      const mSel=document.getElementById('month-select'); const lab=mSel.options[mSel.selectedIndex]?.text||'месяц';
      label.textContent=`Отчёт за месяц: ${lab} (${currentBranch})`;
    }
  }
  function activateDdsTab(mode){
    document.querySelectorAll('#dds-section .tab').forEach(t=>t.classList.toggle('active', t.dataset.mode===mode));
    document.getElementById('controls-date').style.display=(mode==='дата')?'flex':'none';
    document.getElementById('controls-month').style.display=(mode==='месяц')?'flex':'none';
  }
  function setDate(){
    const v=document.getElementById('date-input').value; if(!v) return alert('Выберите дату');
    const [y,m,d]=v.split('-'); const f=`${d}.${m}.${y}`;
    fetch(`/set-date?value=${encodeURIComponent(f)}&branch=${encodeURIComponent(currentBranch)}`)
      .then(()=>{ currentMode='дата'; activateDdsTab('дата'); loadSummary('дата'); updatePeriodLabel('дата'); document.activeElement?.blur(); });
  }
  function setMonth(){
    const m=document.getElementById('month-select').value;
    fetch(`/set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`)
      .then(()=>{ currentMode='месяц'; activateDdsTab('месяц'); loadSummary('месяц'); updatePeriodLabel('месяц'); document.activeElement?.blur(); });
  }

  // Расшифровка
  const bdModal=document.getElementById('bd-modal'); const bdList=document.getElementById('bd-list'); const bdPager=document.getElementById('bd-pager');
  let bdPage=1, bdLimit=50, bdTotal=0;
  document.getElementById('btn-breakdown').addEventListener('click', openBreakdown);
  document.getElementById('bd-close').addEventListener('click', ()=>bdModal.classList.remove('show'));
  document.getElementById('bd-search').addEventListener('input',()=>{clearTimeout(window.__bd_t); window.__bd_t=setTimeout(()=>{bdPage=1; fetchBreakdown();},300);});
  function openBreakdown(){ document.getElementById('bd-title').textContent=`Расшифровка — ${currentBranch} · ${currentMode}`; bdPage=1; fetchBreakdown(); bdModal.classList.add('show'); }
  function fetchBreakdown(){
    const search=document.getElementById('bd-search').value.trim();
    const q=new URLSearchParams({branch:currentBranch, scope:currentMode, page:bdPage, limit:bdLimit, search});
    fetch(`/breakdown?${q.toString()}`).then(r=>r.json()).then(d=>{
      bdTotal=d.total||0; renderBreakdown(d.data||[]);
      const from=Math.min((bdPage-1)*bdLimit+1, bdTotal), to=Math.min(bdPage*bdLimit, bdTotal);
      bdPager.innerHTML=`${bdTotal?from:0}-${to} из ${bdTotal}&nbsp;&nbsp;<button ${bdPage<=1?'disabled':''} onclick="bdPrev()">Назад</button> <button ${bdPage*bdLimit>=bdTotal?'disabled':''} onclick="bdNext()">Вперёд</button>`;
    });
  }
  window.bdPrev=()=>{ if(bdPage>1){ bdPage--; fetchBreakdown(); } };
  window.bdNext=()=>{ if(bdPage*bdLimit<bdTotal){ bdPage++; fetchBreakdown(); } };
  function renderBreakdown(rows){
    bdList.innerHTML = rows.map(x=>{
      const raw=(x.amount||'').toString(); const val=parseNumber(raw); const cls=Number.isFinite(val)?(val<0?'amt-neg':'amt-pos'):'';
      return `<div class="row"><div class="top"><div>${x.article||''}</div><div class="amount ${cls}">${raw}</div></div><div class="bottom"><div><b>Контрагент:</b> ${x.counterparty||'-'}</div><div><b>Назначение:</b> ${x.purpose||'-'}</div></div></div>`;
    }).join('');
    bdList.querySelectorAll('.row').forEach(r=>r.addEventListener('click',()=>r.classList.toggle('open')));
  }

  // Ученики
  function openStudents(){ showOnly('students-section'); document.getElementById('students-branch-label').innerText=currentBranch; loadStudents(); }
  function closeStudents(){ showOnly('dashboard-section'); }
  function studentsSetMonth(){ const m=document.getElementById('students-month-select').value; fetch(`/students-set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`).then(()=>loadStudents()); }
  function loadStudents(){ fetch(`/students?branch=${encodeURIComponent(currentBranch)}&mode=${encodeURIComponent(studentsMode)}`).then(r=>r.json()).then(d=>{ const rows=d?.rows||[]; document.getElementById('students-table').innerHTML=rows.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join(''); }); }
  document.getElementById('students-tab-current')?.addEventListener('click',()=>{ studentsMode='current'; document.getElementById('students-tab-current').classList.add('active'); document.getElementById('students-tab-month').classList.remove('active'); document.getElementById('students-month-controls').style.display='none'; document.getElementById('students-period-label').innerText='Отчет (текущий)'; loadStudents(); });
  document.getElementById('students-tab-month')?.addEventListener('click',()=>{ studentsMode='month'; document.getElementById('students-tab-current').classList.remove('active'); document.getElementById('students-tab-month').classList.add('active'); document.getElementById('students-month-controls').style.display='inline-flex'; document.getElementById('students-period-label').innerText='Отчет (за выбранный месяц)'; loadStudents(); });

  // Сотрудники
  function openStaff(){ showOnly('staff-section'); document.getElementById('staff-branch-label').innerText=currentBranch; loadStaff(); }
  function closeStaff(){ showOnly('dashboard-section'); }
  function staffSetMonth(){ const m=document.getElementById('staff-month-select').value; fetch(`/staff-set-month?value=${encodeURIComponent(m)}&branch=${encodeURIComponent(currentBranch)}`).then(()=>loadStaff()); }
  function loadStaff(){ fetch(`/staff?branch=${encodeURIComponent(currentBranch)}&mode=${encodeURIComponent(staffMode)}`).then(r=>r.json()).then(d=>{ const rows=d?.rows||[]; document.getElementById('staff-table').innerHTML=rows.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join(''); }); }
  document.getElementById('staff-tab-current')?.addEventListener('click',()=>{ staffMode='current'; document.getElementById('staff-tab-current').classList.add('active'); document.getElementById('staff-tab-month').classList.remove('active'); document.getElementById('staff-month-controls').style.display='none'; document.getElementById('staff-period-label').innerText='Отчет (текущий)'; loadStaff(); });
  document.getElementById('staff-tab-month')?.addEventListener('click',()=>{ staffMode='month'; document.getElementById('staff-tab-current').classList.remove('active'); document.getElementById('staff-tab-month').classList.add('active'); document.getElementById('staff-month-controls').style.display='inline-flex'; document.getElementById('staff-period-label').innerText='Отчет (за выбранный месяц)'; loadStaff(); });

  // Платёжный календарь
  function openPK(){ showOnly('pk-section'); loadPK(); }
  function closePK(){ showOnly('dashboard-section'); }
  function loadPK(){
    document.getElementById('pk-branch-label').innerText=currentBranch;
    fetch(`/pk?branch=${encodeURIComponent(currentBranch)}`)
      .then(async r=>{ if(!r.ok){ const t=await r.json().catch(()=>({error:'Ошибка'})); throw new Error(t.error||'Ошибка'); } return r.json(); })
      .then(d=>{
        const header=d?.header||[]; const table=d?.table||[];
        document.getElementById('pk-header').innerHTML = header.map(r=>`<tr><td>${r[0]??''}</td><td style="text-align:right">${r[1]??''}</td></tr>`).join('');
        let html=''; for(let i=0;i<table.length;){
          const r1=table[i]||[]; const date=(r1[0]||'').trim(); const incomeRaw=r1[1]||''; const balRaw1=r1[2]||'';
          let income=parseNumber(incomeRaw), expense=0; let balance=Number.isFinite(parseNumber(balRaw1))?parseNumber(balRaw1):null;
          const r2=table[i+1]||[]; const same=!r2[0] || (r2[0]+'').trim()==='';
          if(same){ const expRaw=r2[1]||''; const balRaw2=r2[2]||''; const ev=parseNumber(expRaw); if(Number.isFinite(ev)) expense=ev; const b2=parseNumber(balRaw2); if(Number.isFinite(b2)&&(balance===null||b2!==0)) balance=b2; i+=2; }
          else { i+=1; }
          if(balance===null) balance=0; const balCls=balance<0?'pk-bad':'';
          html+=`<tr><td>${date}</td><td><div class="pk-inout"><div class="pk-income">${Number.isFinite(income)?fmt2(income):(incomeRaw||'')}</div><div class="pk-expense">${Number.isFinite(expense)?fmt2(expense):'0,00'}</div></div></td><td class="${balCls}" style="text-align:right">${fmt2(balance)}</td></tr>`;
        }
        document.getElementById('pk-table').innerHTML=html;
      })
      .catch(e=>alert(e.message));
  }

  // Отчёты
  function openReports(){ showOnly('reports-section'); loadReports(); }
  function closeReports(){ showOnly('dashboard-section'); }
  function renderReports(list){
    const box=document.getElementById('reports-list');
    if(!Array.isArray(list)||list.length===0){ box.innerHTML=''; return; }
    box.innerHTML=list.map(m=>`<div class="dash-block"><div style="font-weight:800; margin-bottom:8px;">${m.title}</div>${m.files.map(f=>`<div class="report-file"><a href="${f.url}" target="_blank" rel="noopener">${f.name}</a></div>`).join('')}</div>`).join('');
  }
  function loadReports(){ fetch('/reports').then(r=>r.json()).then(d=>renderReports(d?.months||[])); }

  // Инициализация
  document.addEventListener('DOMContentLoaded', ()=>{
    fillMonthSelect(document.getElementById('month-select'));
    fillMonthSelect(document.getElementById('students-month-select'));
    fillMonthSelect(document.getElementById('staff-month-select'));

    document.querySelectorAll('#dds-section .tab').forEach(tab=>{
      tab.addEventListener('click',()=>{ const mode=tab.dataset.mode; currentMode=mode; activateDdsTab(mode); loadSummary(mode); updatePeriodLabel(mode); });
    });

    document.getElementById('bd-modal').addEventListener('click',e=>{ if(e.target.id==='bd-modal') bdModal.classList.remove('show'); });

    // старт: главная
    showOnly('dashboard-section');
    loadSvod();

    setInterval(()=>{
      if(isVisible('dashboard-section')) loadSvod();
      if(isVisible('dds-section')) loadSummary(currentMode);
      if(isVisible('students-section')) loadStudents();
      if(isVisible('staff-section')) loadStaff();
      if(isVisible('pk-section')) loadPK();
      if(isVisible('reports-section')) loadReports();
    }, 30000);
  });
</script>
</body>
</html>

